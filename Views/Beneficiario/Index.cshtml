@model IEnumerable<Donaciones.Models.BeneficiarioModels>
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<h1 class="text-center">Beneficiarios</h1>
<p>
    <a asp-action="Create" class="btn btn-outline-primary">Nuevo</a>
</p>

<!-- Tabla de Beneficiarios -->
<table class="table table-responsive table-bordered table-striped" id="tablaBeneficiarios">
    <thead>
        <tr>
            <th>#</th>
            <th>Nombre</th>
            <th>Acciones</th>
        </tr>
    </thead>
    <tbody>
        <!-- Los datos se mostrarán aquí -->
    </tbody>
</table>

<!-- Scripts -->
<script src="~/lib/jquery/dist/jquery.min.js"></script>
<script>
    $(document).ready(function() {
        obtenerBeneficiarios();
    });

    function obtenerBeneficiarios() {
        // Mostrar mensaje de carga
        $("#tablaBeneficiarios tbody").html('<tr><td colspan="3" class="text-center">Cargando datos...</td></tr>');

        // Realizar la solicitud AJAX al controlador
        $.ajax({
            url: '/Beneficiarios/ObtenerBeneficiarios', // Asegúrate de que esta ruta existe en tu controlador
            type: 'GET',
            dataType: 'json',
            success: function(data) {
                console.log("Datos recibidos:", data); // Para depuración
                mostrarBeneficiariosEnTabla(data);
            },
            error: function(xhr, status, error) {
                console.error("Error en la solicitud AJAX:", error);
                console.error("Estado HTTP:", xhr.status);
                console.error("Respuesta:", xhr.responseText);

                $("#tablaBeneficiarios tbody").html(
                    '<tr><td colspan="3" class="text-center text-danger">' +
                    'Error al cargar los datos. Detalles en la consola.' +
                    '</td></tr>'
                );

                // Como plan B, mostrar los datos del modelo inicial si están disponibles
                if ($("#tablaBeneficiarios tbody tr").length <= 1) {
                    mostrarDatosIniciales();
                }
            }
        });
    }

    function mostrarBeneficiariosEnTabla(beneficiarios) {
        var html = '';

        if (beneficiarios && beneficiarios.length > 0) {
            $.each(beneficiarios, function(index, item) {
                html += '<tr>';
                html += '<td>' + (index + 1) + '</td>';
                html += '<td>' + item.nombre + '</td>'; // Asegúrate de que la propiedad sea 'nombre' (minúscula)
                html += '<td>';
                html += '<a class="btn btn-outline-warning" href="/Beneficiarios/Edit/' + item.beneficiarioId + '">Editar</a> | ';
                html += '<a class="btn btn-outline-info" href="/Beneficiarios/Details/' + item.beneficiarioId + '">Detalles</a> | ';
                html += '<a class="btn btn-outline-danger" href="/Beneficiarios/Delete/' + item.beneficiarioId + '">Eliminar</a>';
                html += '</td>';
                html += '</tr>';
            });
        } else {
            html = '<tr><td colspan="3" class="text-center">No hay beneficiarios disponibles</td></tr>';
        }

        $("#tablaBeneficiarios tbody").html(html);
    }

    function mostrarDatosIniciales() {
        // Esta función crea el HTML para los datos del modelo inicial
        var datos = [];
    @foreach (var item in Model)
    {
        @:datos.push({
        @:    index: @(Model.ToList().IndexOf(item)),
        @:    nombre: "@item.Nombre",
        @:    beneficiarioId: @item.BeneficiarioId
        @:});
    }

        console.log("Usando datos iniciales:", datos);

        if (datos.length > 0) {
            var html = '';
            $.each(datos, function(i, item) {
                html += '<tr>';
                html += '<td>' + (item.index + 1) + '</td>';
                html += '<td>' + item.nombre + '</td>';
                html += '<td>';
                html += '<a class="btn btn-outline-warning" href="/Beneficiarios/Edit/' + item.beneficiarioId + '">Editar</a> | ';
                html += '<a class="btn btn-outline-info" href="/Beneficiarios/Details/' + item.beneficiarioId + '">Detalles</a> | ';
                html += '<a class="btn btn-outline-danger" href="/Beneficiarios/Delete/' + item.beneficiarioId + '">Eliminar</a>';
                html += '</td>';
                html += '</tr>';
            });
            $("#tablaBeneficiarios tbody").html(html);
        }
    }
</script>